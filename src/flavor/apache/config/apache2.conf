# Apache 2.4.62+ configuration for Yii2 with HTTP/2 and PHP-FPM
# Optimized for PHP-FPM proxy with Unix socket

# Core Settings
ServerRoot "/etc/apache2"
DefaultRuntimeDir ${APACHE_RUN_DIR}
PidFile ${APACHE_PID_FILE}

# Performance Settings - Optimized for HTTP/2
Timeout 60
KeepAlive On
MaxKeepAliveRequests 500
KeepAliveTimeout 5

# HTTP/2 Configuration
<IfModule http2_module>
    # Enable HTTP/2 protocol
    Protocols h2 h2c http/1.1

    # HTTP/2 Performance tuning
    H2Direct on
    H2MaxSessionStreams 100
    H2InitialWindowSize 65536
    H2MaxFrameSize 16384
    H2MinWorkers 10
    H2MaxWorkers 50
    H2MaxWorkerIdleSeconds 600

    # Enable HTTP/2 Push
    H2Push on
    H2PushPriority * after
    H2PushPriority text/css before
    H2PushPriority image/jpeg after 32
    H2PushPriority image/png after 32
    H2PushPriority application/javascript interleaved

    # Early Hints (103 response)
    H2EarlyHints on
</IfModule>

# User and Group
User ${APACHE_RUN_USER}
Group ${APACHE_RUN_GROUP}

# Basic Security
ServerTokens Prod
ServerSignature Off
HostnameLookups Off
TraceEnable Off
Header always unset "X-Powered-By"
Header unset "X-Powered-By"

# Default ServerName
ServerName localhost

# MPM Event Configuration - Optimized for PHP-FPM proxy
<IfModule mpm_event_module>
    StartServers             3
    MinSpareThreads         25
    MaxSpareThreads        100
    ThreadLimit             64
    ThreadsPerChild         25
    MaxRequestWorkers      400
    MaxConnectionsPerChild 10000

    # Async processing for better PHP-FPM integration
    AsyncRequestWorkerFactor 2
</IfModule>

# Directory permissions
<Directory />
    Options FollowSymLinks
    AllowOverride None
    Require all denied
</Directory>

<Directory /usr/share>
    AllowOverride None
    Require all granted
</Directory>

<Directory /var/www/>
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# Logging Configuration - Container optimized
ErrorLog /proc/self/fd/2
LogLevel warn

# Custom log formats with performance metrics
<IfModule log_config_module>
    # HTTP/2 aware format
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T %{SSL_PROTOCOL}x %{SSL_CIPHER}x %{HTTP2}e" h2_combined

    # Standard formats with timing
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T" combined_time
    LogFormat "%h %l %u %t \"%r\" %>s %O %{ms}T" common_time

    # JSON format for structured logging
    LogFormat "{\"time\":\"%t\",\"remote_ip\":\"%a\",\"host\":\"%V\",\"request\":\"%U\",\"query\":\"%q\",\"method\":\"%m\",\"status\":\"%>s\",\"user_agent\":\"%{User-Agent}i\",\"referer\":\"%{Referer}i\",\"response_time\":\"%{ms}T\"}" json_log
</IfModule>

# Include module configuration
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf

# Ports Configuration
Listen 80

<IfModule ssl_module>
    Listen 443

    # Modern SSL/TLS Configuration for HTTP/2
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    SSLSessionCache "shmcb:/var/cache/apache2/ssl_scache(512000)"
    SSLSessionCacheTimeout 300

    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingCache "shmcb:/var/cache/apache2/ssl_stapling(32768)"
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off
</IfModule>

# Security Headers - Global
<IfModule headers_module>
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Remove PHP version header
    Header always unset "X-Powered-By"
    Header unset "X-Powered-By"
</IfModule>

# MIME Types
<IfModule mime_module>
    TypesConfig /etc/mime.types

    # Additional types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
    AddType application/x-bzip2 .bz2
    AddType application/wasm .wasm
    AddType application/font-woff2 .woff2
</IfModule>

# Compression Configuration - Critical for HTTP/2
<IfModule deflate_module>
    # Enable compression
    SetOutputFilter DEFLATE

    # Don't compress images
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|woff2?)$ no-gzip dont-vary

    # Compress everything else
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
    AddOutputFilterByType DEFLATE text/javascript application/javascript application/json
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml application/rss+xml
    AddOutputFilterByType DEFLATE application/x-font-ttf application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE application/x-font-opentype application/x-font-truetype

    # Compression level
    DeflateCompressionLevel 6

    # Handle proxies
    Header append Vary User-Agent env=!dont-vary
</IfModule>

# Brotli compression if available (better than gzip)
<IfModule brotli_module>
    SetOutputFilter BROTLI
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|woff2?)$ no-br

    BrotliCompressionLevel 6
    BrotliWindowSize 22

    AddOutputFilterByType BROTLI text/html text/plain text/xml text/css
    AddOutputFilterByType BROTLI text/javascript application/javascript application/json
    AddOutputFilterByType BROTLI application/xml application/xhtml+xml application/rss+xml
    AddOutputFilterByType BROTLI image/svg+xml
</IfModule>

# PHP-FPM Proxy Configuration
<IfModule proxy_fcgi_module>
    # Connection pool settings
    <Proxy "unix:/var/run/php/php-fpm.sock|fcgi://php-fpm">
        ProxySet connectiontimeout=5 timeout=60
    </Proxy>

    # PHP file handling
    <FilesMatch "\.php$">
        <If "-f %{REQUEST_FILENAME}">
            SetHandler "proxy:unix:/var/run/php/php-fpm.sock|fcgi://localhost"
        </If>
    </FilesMatch>

    # Security: Deny access to raw php sources
    <FilesMatch "\.phps$">
        Require all denied
    </FilesMatch>

    <FilesMatch "\.php\.">
        Require all denied
    </FilesMatch>
</IfModule>

# Include security configuration
Include /etc/apache2/conf-available/security-enhanced.conf

# Include other configuration files
IncludeOptional conf-enabled/*.conf
IncludeOptional sites-enabled/*.conf

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
