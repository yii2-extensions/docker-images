#==============================================================================
# Apache 2.4.62+ configuration for Yii2 with HTTP/2 and PHP-FPM
#==============================================================================

# Core Settings
ServerRoot "/etc/apache2"
DefaultRuntimeDir ${APACHE_RUN_DIR}
Mutex file:${APACHE_LOCK_DIR} default
PassEnv APACHE_DOCUMENT_ROOT
PidFile ${APACHE_PID_FILE}

# Performance Settings - Optimized for HTTP/2
Timeout 60
KeepAlive On
MaxKeepAliveRequests 500
KeepAliveTimeout 5

# HTTP/2 Configuration
<IfModule http2_module>
    # Enable HTTP/2 protocol
    Protocols h2 h2c http/1.1

    # HTTP/2 Performance tuning
    H2Direct on
    H2MaxSessionStreams 100
    H2InitialWindowSize 65536
    H2MaxFrameSize 16384
    H2MinWorkers 10
    H2MaxWorkers 50
    H2MaxWorkerIdleSeconds 600

    # Enable HTTP/2 Push
    H2Push on
    H2PushPriority * after
    H2PushPriority text/css before
    H2PushPriority image/jpeg after 32
    H2PushPriority image/png after 32
    H2PushPriority application/javascript interleaved

    # Early Hints (103 response)
    H2EarlyHints on
</IfModule>

# User and Group
User ${APACHE_RUN_USER}
Group ${APACHE_RUN_GROUP}

# Basic Security
ServerTokens Prod
ServerSignature Off
HostnameLookups Off
TraceEnable Off
Header always unset "X-Powered-By"
Header unset "X-Powered-By"

# Default ServerName
ServerName localhost

# MPM Event Configuration - Optimized for PHP-FPM proxy
<IfModule mpm_event_module>
    StartServers             3
    MinSpareThreads         25
    MaxSpareThreads        100
    ThreadLimit             64
    ThreadsPerChild         25
    MaxRequestWorkers      400
    MaxConnectionsPerChild 10000

    # Async processing for better PHP-FPM integration
    AsyncRequestWorkerFactor 2
</IfModule>

# Directory permissions
<Directory />
    Options FollowSymLinks
    AllowOverride None
    Require all denied
</Directory>

<Directory /usr/share>
    AllowOverride None
    Require all granted
</Directory>

<Directory /var/www/>
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

# Logging Configuration - Container optimized
ErrorLog ${APACHE_ERROR_LOG_FILE}
LogLevel warn

# Custom log formats with performance metrics
<IfModule log_config_module>
    # HTTP/2 aware format
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T %{SSL_PROTOCOL}x %{SSL_CIPHER}x %{HTTP2}e" h2_combined

    # Standard formats with timing
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T" combined_time
    LogFormat "%h %l %u %t \"%r\" %>s %O %{ms}T" common_time

    # JSON format for structured logging
    LogFormat "{\"time\":\"%t\",\"remote_ip\":\"%a\",\"host\":\"%V\",\"request\":\"%U\",\"query\":\"%q\",\"method\":\"%m\",\"status\":\"%>s\",\"user_agent\":\"%{User-Agent}i\",\"referer\":\"%{Referer}i\",\"response_time\":\"%{ms}T\"}" json_log

    # Emit to stdout by default; switch to json_log if desired.
    CustomLog ${APACHE_ACCESS_LOG} combined_time
</IfModule>

# Include module configuration
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf

# Ports Configuration
Listen 80

<IfModule ssl_module>
    Listen 443

    # Modern SSL/TLS Configuration for HTTP/2
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305
    SSLHonorCipherOrder off
    SSLSessionTickets off
    SSLSessionCache "shmcb:/var/cache/apache2/ssl_scache(512000)"
    SSLSessionCacheTimeout 300

    # OCSP Stapling (disabled for self-signed certificates)
    <IfDefine !DISABLE_OCSP_STAPLING>
        SSLUseStapling on
        SSLStaplingCache "shmcb:/var/cache/apache2/ssl_stapling(32768)"
        SSLStaplingResponderTimeout 5
        SSLStaplingReturnResponderErrors off
    </IfDefine>
</IfModule>

# Security Headers - Global
<IfModule headers_module>
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Remove PHP version header
    Header always unset "X-Powered-By"
    Header unset "X-Powered-By"
</IfModule>

# MIME Types
<IfModule mime_module>
    TypesConfig /etc/mime.types

    # Additional types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
    AddType application/x-bzip2 .bz2
    AddType application/wasm .wasm
    AddType application/font-woff2 .woff2
</IfModule>

# Brotli compression if available (better than gzip)
<IfModule brotli_module>
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|woff2?)$ no-br

    BrotliCompressionLevel 6
    BrotliWindowSize 22

    # only compress text, html, javascript, css, xml, fonts, svg
    AddOutputFilterByType BROTLI text/html text/plain text/xml text/css
    AddOutputFilterByType BROTLI text/javascript application/javascript application/json
    AddOutputFilterByType BROTLI application/xml application/xhtml+xml application/rss+xml
    AddOutputFilterByType BROTLI image/svg+xml

    Header merge Vary "Accept-Encoding"
</IfModule>

# Fallback to gzip if Brotli is not available
<IfModule !brotli_module>
    <IfModule deflate_module>
        SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|woff2?)$ no-gzip dont-vary

        # only compress text, html, javascript, css, xml, fonts, svg
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE text/javascript application/javascript application/json
        AddOutputFilterByType DEFLATE application/xml application/xhtml+xml application/rss+xml
        AddOutputFilterByType DEFLATE application/x-font-ttf application/vnd.ms-fontobject
        AddOutputFilterByType DEFLATE image/svg+xml
        AddOutputFilterByType DEFLATE application/x-font-opentype application/x-font-truetype

        DeflateCompressionLevel 6
        Header merge Vary "Accept-Encoding"
    </IfModule>
</IfModule>

# Include security configuration
Include /etc/apache2/conf-available/security.conf

# Include PHP-FPM proxy configuration
Include /etc/apache2/conf-available/php-fpm-proxy.conf

# Include other configuration files
IncludeOptional conf-enabled/*.conf
IncludeOptional sites-enabled/*.conf

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
