#==============================================================================
# Logging Configuration - Structured and Performance Optimized
# Modern logging formats with performance monitoring
#==============================================================================

#------------------------------------------------------------------------------
# Access Log Configuration
#------------------------------------------------------------------------------
<IfModule log_config_module>
    # Main access log (JSON format recommended for production)
    CustomLog ${APACHE_ACCESS_LOG} json_log env=!no_log

    # Alternative: Combined format with timing (comment above and uncomment below)
    # CustomLog ${APACHE_ACCESS_LOG} combined_time env=!no_log

    # Security log (separate file)
    # CustomLog logs/security.log security_log env=security_request

    # API access log (separate file for APIs)
    # CustomLog logs/api_access.log api_log env=api_request

    # Performance log for slow requests
    # CustomLog logs/slow_requests.log perf_log env=slow_request

    # Error responses log
    # CustomLog logs/client_errors.log combined_time env=client_error
    # CustomLog logs/server_errors.log combined_time env=server_error
</IfModule>

#------------------------------------------------------------------------------
# Conditional Logging
#------------------------------------------------------------------------------
<IfModule log_config_module>
    # Don't log certain requests to reduce noise
    SetEnvIf Request_URI "^/(health|ping|status|fpm-status|fpm-ping|server-status|server-info)(\.php)?$" no_log
    SetEnvIf Request_URI "^/(robots\.txt|favicon\.ico|apple-touch-icon.*\.png)$" no_log
    SetEnvIf Request_URI "^/\.well-known/" no_log

    # Don't log static assets (optional - uncomment if needed)
    # SetEnvIf Request_URI "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf|eot)$" no_log_static

    # Log API requests
    SetEnvIf Request_URI "^/api/" api_request

    # Log error responses
    SetEnvIf Status "^4\d\d" client_error
    SetEnvIf Status "^5\d\d" server_error

    # Log security-related requests separately
    SetEnvIf Request_URI "\.(php|cgi|pl|py|sh|bat)$" security_request
    SetEnvIf Query_String "(union|select|insert|delete|update|drop|exec|script)" security_request
    SetEnvIf User-Agent "(bot|crawler|scan|hack|inject)" security_request

    # Log slow requests
    SetEnvIf Response_Time ">5000" slow_request
</IfModule>

#------------------------------------------------------------------------------
# Custom Log Formats
#------------------------------------------------------------------------------
<IfModule log_config_module>
    # API Log Format
    LogFormat "{\
\"timestamp\":\"%{%Y-%m-%dT%H:%M:%S%z}t\",\
\"ip\":\"%a\",\
\"method\":\"%m\",\
\"endpoint\":\"%U\",\
\"query\":\"%q\",\
\"status\":%>s,\
\"response_time\":%{ms}T,\
\"size\":%O,\
\"user_agent\":\"%{User-Agent}i\",\
\"api_key\":\"%{X-API-Key}i\",\
\"rate_limit\":\"%{X-RateLimit-Remaining}o\"\
}" api_log

    # Error Log Format (for CustomLog, not ErrorLog)
    LogFormat "%t [ERROR] %a \"%r\" %>s \"%{User-Agent}i\" error:\"%e\"" error_log_format

    # HTTP/2 Enhanced Format
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T proto:%{HTTP2}e ssl:%{SSL_PROTOCOL}x cipher:%{SSL_CIPHER}x" h2_combined

    # JSON Format for Structured Logging
    LogFormat "{\
\"timestamp\":\"%{%Y-%m-%dT%H:%M:%S%z}t\",\
\"remote_ip\":\"%a\",\
\"remote_host\":\"%h\",\
\"request_id\":\"%{UNIQUE_ID}e\",\
\"user\":\"%u\",\
\"method\":\"%m\",\
\"url\":\"%U\",\
\"query\":\"%q\",\
\"protocol\":\"%H\",\
\"status\":%>s,\
\"response_size\":%O,\
\"referer\":\"%{Referer}i\",\
\"user_agent\":\"%{User-Agent}i\",\
\"response_time_ms\":%{ms}T,\
\"response_time_us\":%D,\
\"http2\":\"%{HTTP2}e\",\
\"ssl_protocol\":\"%{SSL_PROTOCOL}x\",\
\"ssl_cipher\":\"%{SSL_CIPHER}x\",\
\"forwarded_for\":\"%{X-Forwarded-For}i\",\
\"host\":\"%{Host}i\",\
\"server_name\":\"%v\",\
\"connection_status\":\"%X\"\
}" json_log

    # Performance Log Format (detailed timing)
    LogFormat "%t [PERF] %D %{ms}T \"%r\" %>s %O conn:%{c}L req:%{i}L" perf_log

    # Security Log Format
    LogFormat "%t [SECURITY] %a \"%r\" %>s \"%{User-Agent}i\" \"%{Referer}i\"" security_log

    # Standard Combined Format with Response Time
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T" combined_time
</IfModule>

#------------------------------------------------------------------------------
# Error Log Customization
#------------------------------------------------------------------------------
# Error log format (Apache 2.4.13+)
<IfModule mod_log_debug.c>
    ErrorLogFormat "[%{u}t] [%-m:%l] [pid %P:tid %T] %7F: %E: [client\ %a] %M% ,\ referer\ %{Referer}i"
</IfModule>

# Log specific modules at different levels
LogLevel rewrite:warn
LogLevel ssl:warn
LogLevel deflate:warn
LogLevel headers:warn

#------------------------------------------------------------------------------
# Log Rotation and Management
#------------------------------------------------------------------------------
# Note: Log rotation is typically handled by logrotate
# Example logrotate configuration should be placed in /etc/logrotate.d/apache2

# For immediate log management, you can use:
<IfModule mod_log_rotate.c>
    # Rotate logs daily (if mod_log_rotate is available)
    RotateLogs logs/access.log 86400
    RotateLogs logs/error.log 86400
</IfModule>

#------------------------------------------------------------------------------
# Performance Monitoring Integration
#------------------------------------------------------------------------------
# Integration with monitoring tools
<IfModule mod_headers.c>
    # Add unique request ID for tracking
    <IfModule mod_unique_id.c>
        Header always set X-Request-ID %{UNIQUE_ID}e

        # Add to logs
        LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T rid:%{UNIQUE_ID}e" combined_with_id

        # Uncomment to use this format instead of the default
        # CustomLog ${APACHE_ACCESS_LOG} combined_with_id env=!no_log
    </IfModule>

    # Response time header (for monitoring)
    Header always set X-Response-Time "%D Î¼s"

    # Server load header (if mod_status is enabled)
    # Header always set X-Server-Load "%{SERVER_LOAD}e"
</IfModule>

#------------------------------------------------------------------------------
# SSL Specific Logging
#------------------------------------------------------------------------------
<IfModule mod_ssl.c>
    <IfModule log_config_module>
        # SSL-specific log format
        LogFormat "%t [SSL] %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %>s" ssl_log

        # SSL handshake logging (very verbose, use only for debugging)
        # LogLevel ssl:debug
        # CustomLog logs/ssl_request.log ssl_log
    </IfModule>
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
