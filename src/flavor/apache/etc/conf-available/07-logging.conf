#==============================================================================
# Logging Configuration - Structured and Performance Optimized
# Modern logging formats with performance monitoring
#==============================================================================

#------------------------------------------------------------------------------
# Access Log Configuration
#------------------------------------------------------------------------------
<IfModule log_config_module>
    # Main access log (JSON format recommended for production)
    CustomLog ${APACHE_ACCESS_LOG} json_log env=!no_log
</IfModule>

#------------------------------------------------------------------------------
# Conditional Logging
#------------------------------------------------------------------------------
<IfModule log_config_module>
    # Don't log certain requests to reduce noise
    SetEnvIf Request_URI "^/(health|ping|status|fpm-status|fpm-ping|server-status|server-info)(\.php)?$" no_log
    SetEnvIf Request_URI "^/(robots\.txt|favicon\.ico|apple-touch-icon.*\.png)$" no_log
    SetEnvIf Request_URI "^/\.well-known/" no_log

    # Don't log static assets (optional - uncomment if needed)
    # SetEnvIf Request_URI "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf|eot)$" no_log_static

    # Log API requests
    SetEnvIf Request_URI "^/api/" api_request

    # Log security-related requests (for example, potential attacks)
    SetEnvIfNoCase Request_URI "\.(php|cgi|pl|py|sh|bat)$" security_request
    SetEnvIfNoCase Query_String "\b(union|select|insert|delete|update|drop|exec|script)\b" security_request
    SetEnvIfNoCase User-Agent "(bot|crawler|scan|hack|inject)" security_request
</IfModule>

#------------------------------------------------------------------------------
# Custom Log Formats
#------------------------------------------------------------------------------
<IfModule log_config_module>
    # API Log Format
    LogFormat "{\
\"timestamp\":\"%{%Y-%m-%dT%H:%M:%S%z}t\",\
\"ip\":\"%a\",\
\"method\":\"%m\",\
\"endpoint\":\"%U\",\
\"query\":\"%q\",\
\"status\":%>s,\
\"response_time\":%{ms}T,\
\"size\":%O,\
\"user_agent\":\"%{User-Agent}i\",\
\"api_key\":\"[redacted]\",\
\"rate_limit\":\"%{X-RateLimit-Remaining}o\"\
}" api_log

    # HTTP/2 Enhanced Format
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T proto:%{HTTP2}n ssl:%{SSL_PROTOCOL}x cipher:%{SSL_CIPHER}x" h2_combined

    # JSON Format for Structured Logging
    LogFormat "{\
\"timestamp\":\"%{%Y-%m-%dT%H:%M:%S%z}t\",\
\"remote_ip\":\"%a\",\
\"remote_host\":\"%h\",\
\"request_id\":\"%{UNIQUE_ID}e\",\
\"user\":\"%u\",\
\"method\":\"%m\",\
\"url\":\"%U\",\
\"query\":\"%q\",\
\"protocol\":\"%H\",\
\"status\":%>s,\
\"response_size\":%O,\
\"referer\":\"%{Referer}i\",\
\"user_agent\":\"%{User-Agent}i\",\
\"response_time_ms\":%{ms}T,\
\"response_time_us\":%D,\
\"http2\":\"%{HTTP2}n\",\
\"ssl_protocol\":\"%{SSL_PROTOCOL}x\",\
\"ssl_cipher\":\"%{SSL_CIPHER}x\",\
\"forwarded_for\":\"%{X-Forwarded-For}i\",\
\"host\":\"%{Host}i\",\
\"server_name\":\"%v\",\
\"connection_status\":\"%X\"\
}" json_log

    # Performance Log Format (detailed timing)
    LogFormat "%t [PERF] %D %{ms}T \"%r\" %>s %O conn:%{c}L req:%{i}L" perf_log

    # Security Log Format
    LogFormat "%t [SECURITY] %a \"%r\" %>s \"%{User-Agent}i\" \"%{Referer}i\"" security_log

    # Standard Combined Format with Response Time
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T" combined_time
</IfModule>

#------------------------------------------------------------------------------
# Error Log Customization
#------------------------------------------------------------------------------
# Apache 2.4.13+ supports ErrorLogFormat
ErrorLogFormat "[%{u}t] [%-m:%l] [pid %P:tid %T] %7F: %E: [client %a] %M, referer %{Referer}i"

# Log specific modules at different levels
LogLevel brotli:warn
LogLevel deflate:warn
LogLevel headers:warn
LogLevel rewrite:warn
LogLevel ssl:warn

#------------------------------------------------------------------------------
# Performance Monitoring Integration
#------------------------------------------------------------------------------
# Integration with monitoring tools
<IfModule mod_headers.c>
    # Add unique request ID for tracking
    <IfModule mod_unique_id.c>
        # Set unique ID in request header
        Header always set X-Request-ID "expr=%{reqenv:UNIQUE_ID}"

        # Add to logs
        LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T rid:%{UNIQUE_ID}e" combined_with_id
    </IfModule>
</IfModule>

#------------------------------------------------------------------------------
# SSL Specific Logging
#------------------------------------------------------------------------------
<IfModule mod_ssl.c>
    <IfModule log_config_module>
        # SSL-specific log format
        LogFormat "%t [SSL] %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %>s" ssl_log
    </IfModule>
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
