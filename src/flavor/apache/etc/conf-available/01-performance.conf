#==============================================================================
# Performance Optimization Configuration
# MPM, KeepAlive, HTTP/2 Settings
#==============================================================================

#------------------------------------------------------------------------------
# Connection Settings
#------------------------------------------------------------------------------
KeepAlive On
KeepAliveTimeout 2
MaxKeepAliveRequests 1000
Timeout 60

#------------------------------------------------------------------------------
# HTTP/2 Configuration
#------------------------------------------------------------------------------
<IfModule http2_module>
    # Connection management
    H2MaxWorkerIdleSeconds 600
    H2MaxWorkers 50
    H2MinWorkers 10

    # Early Hints for better performance
    H2EarlyHints on

    # HTTP/2 logging
    H2SerializeHeaders off

    # HTTP/2 Performance Settings
    H2Direct on
    H2MaxSessionStreams 100
    H2Push off
    H2StreamMaxMemSize 65536

    # Protocol priorities
    Protocols h2 h2c http/1.1

    # Security and compatibility
    H2ModernTLSOnly on
    H2Upgrade on
</IfModule>

#------------------------------------------------------------------------------
# Memory and Resource Management
# Prevent memory leaks and optimize resource usage
#------------------------------------------------------------------------------
<IfModule mpm_event_module>
    # Graceful shutdowns
    GracefulShutdownTimeout 10
</IfModule>

#------------------------------------------------------------------------------
# MPM Event Configuration
#------------------------------------------------------------------------------
<IfModule mpm_event_module>
    # Factor of 2 means each worker can handle 2x connections than threads
    AsyncRequestWorkerFactor 2

    # Set ServerLimit to accommodate MaxRequestWorkers
    ServerLimit             32

    # Calculated for 16GB server (adjust according to your RAM)
    MaxConnectionsPerChild 5000
    MaxRequestWorkers      800
    MaxSpareThreads        100
    MinSpareThreads         25
    StartServers             4
    ThreadLimit             64
    ThreadsPerChild         25

    # Listen queue optimization
    ListenBackLog 511
</IfModule>

#------------------------------------------------------------------------------
# Process Priority
#------------------------------------------------------------------------------
# Set process priority (if needed)
# <IfModule mod_systemd.c>
#     SystemdNotify on
# </IfModule>

#------------------------------------------------------------------------------
# SendFile Optimization
#------------------------------------------------------------------------------
# Enable sendfile for better static file performance
EnableMMAP On
EnableSendfile On

# Send file optimization for static content
<Directory /var/www>
    EnableMMAP On
    EnableSendfile On
</Directory>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
