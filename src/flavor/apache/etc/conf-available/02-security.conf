#==============================================================================
# Security Configuration
# Headers, Protection, and Hardening
#==============================================================================

#------------------------------------------------------------------------------
# Error Page Security
#------------------------------------------------------------------------------
# Custom error pages (prevent information disclosure)
ErrorDocument 400 "Bad Request"
ErrorDocument 401 "Unauthorized"
ErrorDocument 403 "Forbidden"
ErrorDocument 404 "Not Found"
ErrorDocument 500 "Internal Server Error"
ErrorDocument 502 "Bad Gateway"
ErrorDocument 503 "Service Unavailable"

#------------------------------------------------------------------------------
# IP and Request Filtering
#------------------------------------------------------------------------------
# Block common malicious patterns
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Block common exploit attempts
    RewriteCond %{REQUEST_URI} (wp-|wordpress|admin|phpmyadmin|pma|sql|mysql|ftp|cpanel|webmail|roundcube|horde) [NC]
    RewriteRule .* - [F,L]

    # Block file injection attempts
    RewriteCond %{REQUEST_URI} \.(php|inc|conf|sql|cgi|sh|bat)\. [NC]
    RewriteRule .* - [F,L]

    # Block malicious query strings
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} proc/self/environ [OR]
    RewriteCond %{QUERY_STRING} mosConfig_[a-zA-Z_]{1,21}(=|\%3D) [OR]
    RewriteCond %{QUERY_STRING} base64_(en|de)code[^(]*\([^)]*\) [OR]
    RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*(iframe|object|embed).*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (union.*select|insert.*into|delete.*from|update.*set) [NC]
    RewriteRule .* - [F,L]

    # Block malicious user agents
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} ^(java|curl|wget|python|perl|libwww|lwp-trivial|echo|bot|scan|nikto|nessus|sqlmap|w3af|acunetix|netsparker|burp|ZAP) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (eval\(|javascript:|vbscript:|onload=|onerror=|onclick=) [NC]
    RewriteRule .* - [F,L]
</IfModule>

#------------------------------------------------------------------------------
# File and Directory Protection
#------------------------------------------------------------------------------
# Backup and Temporary Files
<FilesMatch "\.(bak|backup|old|orig|save|tmp|temp|swp|swo|~|#)$">
    Require all denied
</FilesMatch>

<FilesMatch "^#.*#$">
    Require all denied
</FilesMatch>

# CI/CD and Build Files
<FilesMatch "^(\.gitlab-ci\.yml|\.github|\.travis\.yml|\.circleci|Jenkinsfile|Dockerfile.*|docker-compose.*|\.dockerignore|Makefile|\.editorconfig|\.gitignore|\.gitattributes)$">
    Require all denied
</FilesMatch>

<DirectoryMatch "/(\.github|\.circleci|\.gitlab)/">
    Require all denied
</DirectoryMatch>

# Configuration Files
<FilesMatch "^(\.env.*|\.config|config\.(php|ini|yaml|yml|json)|params\.php|web\.config|\.htaccess|\.htpasswd)$">
    Require all denied
</FilesMatch>

# Database Files
<FilesMatch "\.(sql|sqlite|db|mdb)$">
    Require all denied
</FilesMatch>

# Log Files
<FilesMatch "\.(log|logs)$">
    Require all denied
</FilesMatch>

# Package Managers
<FilesMatch "^(composer\.(json|lock)|package\.(json|lock)|yarn\.lock|pnpm-lock\.yaml|bower\.json|Gemfile|requirements\.txt|pipfile|poetry\.lock)$">
    Require all denied
</FilesMatch>

# Source Code Files
<FilesMatch "\.(php~|php_bak|phps)$">
    Require all denied
</FilesMatch>

# Version Control Systems
<DirectoryMatch "/(\.git|\.svn|\.hg|\.bzr|CVS|\.cvs)">
    Require all denied
</DirectoryMatch>

#------------------------------------------------------------------------------
# Framework-Specific Protection (Yii2)
#------------------------------------------------------------------------------
# PHP Configuration Files
<FilesMatch "^(php\.ini|\.user\.ini|php\.ini-.*|php_errors\.log)$">
    Require all denied
</FilesMatch>

# Yii2 Framework Directories
<DirectoryMatch "/(runtime|vendor|tests|config|models|controllers|commands|migrations|mail|widgets|components)">
    Require all denied
</DirectoryMatch>

# Yii2 Specific Files
<FilesMatch "^(yii|yii\.bat|yii\.php|requirements\.php|init|init\.bat|codeception\.yml)$">
    Require all denied
</FilesMatch>

#------------------------------------------------------------------------------
# Request Method Security
# Disable dangerous HTTP methods
#------------------------------------------------------------------------------
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Block OPTIONS except for CORS preflight
    RewriteCond %{REQUEST_METHOD} ^OPTIONS$
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteRule .* - [F,L]

    # Block TRACE and TRACK methods
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F,L]
</IfModule>

#------------------------------------------------------------------------------
# Request Size and Timeout Limits
#------------------------------------------------------------------------------
# Prevent DoS attacks
LimitRequestBody 104857600
LimitRequestFields 100
LimitRequestFieldSize 8190
LimitRequestLine 8190

#------------------------------------------------------------------------------
# Security Headers
#------------------------------------------------------------------------------
<IfModule mod_headers.c>
    # Content Security and MIME Protection
    Header always setifempty X-Content-Type-Options "nosniff"
    Header always setifempty X-Frame-Options "SAMEORIGIN"
    Header always setifempty X-XSS-Protection "1; mode=block"

    # Content Security Policy - Strict Default
    Header always setifempty Content-Security-Policy "\
        default-src 'self'; \
        script-src 'self' 'unsafe-inline' 'unsafe-eval'; \
        style-src 'self' 'unsafe-inline'; \
        img-src 'self' data: https:; \
        font-src 'self' data:; \
        connect-src 'self'; \
        media-src 'self'; \
        object-src 'none'; \
        child-src 'self'; \
        frame-src 'self'; \
        worker-src 'self'; \
        frame-ancestors 'self'; \
        form-action 'self'; \
        base-uri 'self'; \
        manifest-src 'self'"

    # Cross-Origin Policies
    Header always setifempty Cross-Origin-Embedder-Policy "require-corp"
    Header always setifempty Cross-Origin-Opener-Policy "same-origin"
    Header always setifempty Cross-Origin-Resource-Policy "same-origin"

    # Cookie Security
    Header always edit Set-Cookie ^(.*)$ "$1; HttpOnly; Secure; SameSite=Strict"
    Header always edit Set-Cookie ^(.*);\s*HttpOnly.*$ "$1; HttpOnly"
    Header always edit Set-Cookie ^(.*);\s*Secure.*$ "$1; Secure"

    # Modern Permissions Policy (Feature Policy replacement)
    Header always setifempty Permissions-Policy "\
        accelerometer=(), \
        autoplay=(), \
        bluetooth=(), \
        browsing-topics=(), \
        camera=(), \
        clipboard-read=(), \
        clipboard-write=(), \
        cross-origin-isolated=(), \
        display-capture=(), \
        encrypted-media=(), \
        fullscreen=(self), \
        gamepad=(), \
        geolocation=(), \
        gyroscope=(), \
        hid=(), \
        idle-detection=(), \
        interest-cohort=(), \
        keyboard-map=(), \
        local-fonts=(), \
        magnetometer=(), \
        microphone=(), \
        midi=(), \
        payment=(), \
        picture-in-picture=(), \
        publickey-credentials-get=(), \
        screen-wake-lock=(), \
        serial=(), \
        storage-access=(), \
        sync-xhr=(self), \
        usb=(), \
        web-share=(), \
        window-management=(), \
        xr-spatial-tracking=()"

    # Referrer and Privacy Protection
    Header always setifempty Referrer-Policy "strict-origin-when-cross-origin"

    # Remove Server Information
    Header always unset "Server"
    Header always unset "X-Powered-By"
    Header unset "Server"
    Header unset "X-Powered-By"
</IfModule>

#------------------------------------------------------------------------------
# Server Information Disclosure Protection
#------------------------------------------------------------------------------
HostnameLookups Off
ServerSignature Off
ServerTokens Prod
TraceEnable Off

#------------------------------------------------------------------------------
# Upload Security
#------------------------------------------------------------------------------
# Prevent PHP execution in upload directories
<DirectoryMatch "/(uploads|files|media|images|attachments|assets/uploads)/">
    <FilesMatch "\.(php|php3|php4|php5|php7|php8|phtml|pl|py|jsp|asp|sh|cgi)$">
        Require all denied
    </FilesMatch>

    # Set proper MIME types for uploads
    <IfModule mod_headers.c>
        Header always set X-Content-Type-Options "nosniff"
    </IfModule>
</DirectoryMatch>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
