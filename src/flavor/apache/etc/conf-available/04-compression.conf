#==============================================================================
# Compression Configuration - Brotli + Gzip Optimization
# Modern compression for better performance
#==============================================================================

#------------------------------------------------------------------------------
# Brotli Compression (Preferred)
#------------------------------------------------------------------------------
<IfModule mod_brotli.c>
    # Content types to compress
    AddOutputFilterByType BROTLI \
        text/html \
        text/plain \
        text/xml \
        text/css \
        text/javascript \
        text/x-component \
        text/x-js \
        text/richtext \
        text/xsd \
        text/xsl \
        application/javascript \
        application/x-javascript \
        application/json \
        application/ld+json \
        application/xml \
        application/xhtml+xml \
        application/rss+xml \
        application/atom+xml \
        application/x-font-ttf \
        application/vnd.ms-fontobject \
        application/x-font-opentype \
        application/x-font-truetype \
        application/font-woff \
        application/font-woff2 \
        application/manifest+json \
        image/svg+xml \
        image/x-icon

    # Compression settings
    BrotliCompressionLevel 6
    BrotliCompressionMaxInputBlock 0
    BrotliCompressionWindowSize 22

    # Enable Brotli compression
    SetOutputFilter BROTLI

    # Don't compress already compressed files
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png|webp|woff2?|ico|zip|gz|rar|bz2|7z|tar|lzma|Z)$ \
        no-br no-gzip dont-vary

    # Don't compress small files (< 1KB)
    SetEnvIf Content-Length "^[0-9][0-9][0-9]$" no-br

    # Set proper Vary header
    <IfModule mod_headers.c>
        Header merge Vary "Accept-Encoding"
    </IfModule>
</IfModule>

#------------------------------------------------------------------------------
# Gzip Compression (Fallback)
#------------------------------------------------------------------------------
<IfModule mod_deflate.c>
    # Only use gzip if Brotli is not available
    <IfModule !mod_brotli.c>
        SetOutputFilter DEFLATE

        # Compression level (6 is good balance)
        DeflateCompressionLevel 6
        DeflateMemLevel 9
        DeflateWindowSize 15

        # Content types to compress (same as Brotli)
        AddOutputFilterByType DEFLATE \
            text/html \
            text/plain \
            text/xml \
            text/css \
            text/javascript \
            text/x-component \
            text/x-js \
            text/richtext \
            text/xsd \
            text/xsl \
            application/javascript \
            application/x-javascript \
            application/json \
            application/ld+json \
            application/xml \
            application/xhtml+xml \
            application/rss+xml \
            application/atom+xml \
            application/x-font-ttf \
            application/vnd.ms-fontobject \
            application/x-font-opentype \
            application/x-font-truetype \
            application/font-woff \
            application/manifest+json \
            image/svg+xml \
            image/x-icon

        # Don't compress already compressed files
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png|webp|woff2?|ico|zip|gz|rar|bz2|7z|tar|lzma|Z)$ \
            no-gzip dont-vary

        # Don't compress small files
        SetEnvIf Content-Length "^[0-9][0-9][0-9]$" no-gzip

        # Netscape 4.x workaround
        BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
        BrowserMatch ^Mozilla/4 gzip-only-text/html
        BrowserMatch ^Mozilla/4\.0[678] no-gzip

        # Set proper Vary header
        <IfModule mod_headers.c>
            Header merge Vary "Accept-Encoding"
        </IfModule>
    </IfModule>
</IfModule>

#------------------------------------------------------------------------------
# Quality Control
#------------------------------------------------------------------------------
# Don't compress for slow connections
<IfModule mod_headers.c>
    # Check connection speed and adjust compression
    SetEnvIf User-Agent ".*MSIE.*" ie_user_agent
    Header set Vary "Accept-Encoding, User-Agent" env=ie_user_agent
</IfModule>

# Pre-compression support (if you pre-compress files)
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Serve pre-compressed .br files if available
    RewriteCond %{HTTP:Accept-Encoding} br
    RewriteCond %{REQUEST_FILENAME}\.br -s
    RewriteRule ^(.*)$ $1\.br [QSA,L]

    # Serve pre-compressed .gz files if available (fallback)
    RewriteCond %{HTTP:Accept-Encoding} gzip
    RewriteCond %{REQUEST_FILENAME}\.gz -s
    RewriteRule ^(.*)$ $1\.gz [QSA,L]

    # Set proper content type for pre-compressed files
    <FilesMatch "\.css\.br$">
        Header set Content-Type "text/css"
        Header set Content-Encoding "br"
    </FilesMatch>

    <FilesMatch "\.js\.br$">
        Header set Content-Type "application/javascript"
        Header set Content-Encoding "br"
    </FilesMatch>

    <FilesMatch "\.css\.gz$">
        Header set Content-Type "text/css"
        Header set Content-Encoding "gzip"
    </FilesMatch>

    <FilesMatch "\.js\.gz$">
        Header set Content-Type "application/javascript"
        Header set Content-Encoding "gzip"
    </FilesMatch>
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
