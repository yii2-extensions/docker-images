#==============================================================================
# Basic Security Settings
#==============================================================================

# Disable access to the entire file system except explicitly allowed directories
<Directory />
    AllowOverride None
    Require all denied
    Options -Indexes -Includes -ExecCGI
</Directory>

# Disable server signature and information disclosure
ServerTokens Prod
ServerSignature Off
TraceEnable Off

#==============================================================================
# Version Control and Sensitive File Protection
#==============================================================================

# Forbid access to version control directories
<DirectoryMatch "/(\.git|\.svn|\.hg|\.bzr|CVS)">
    Require all denied
</DirectoryMatch>

# Prevent access to CI/CD and development files
<FilesMatch "^(\.gitlab-ci\.yml|\.github|\.travis\.yml|\.circleci|Jenkinsfile|Dockerfile.*|docker-compose.*|\.dockerignore)$">
    Require all denied
</FilesMatch>

# Protect CI/CD directories and their contents
<DirectoryMatch "/(\.github|\.circleci)/">
    Require all denied
</DirectoryMatch>

# Protect package manager files
<FilesMatch "^(composer\.(json|lock)|package\.(json|lock)|yarn\.lock|pnpm-lock\.yaml|bower\.json)$">
    Require all denied
</FilesMatch>

# Protect environment and configuration files
<FilesMatch "^(\.env.*|\.config|config\.php|params\.php|web\.config|\.htaccess)$">
    Require all denied
</FilesMatch>

# Protect backup and temporary files
<FilesMatch "\.(bak|backup|old|tmp|temp|swp|swo|~)$">
    Require all denied
</FilesMatch>

# Protect log files
<FilesMatch "\.(log|logs)$">
    Require all denied
</FilesMatch>

#==============================================================================
# Framework-Specific Protection
#==============================================================================

# Protect Yii2 framework directories
<DirectoryMatch "/(runtime|vendor|tests|config|models|controllers|commands|migrations|mail|widgets)">
    Require all denied
</DirectoryMatch>

# Protect Yii2 asset directories from executing PHP files
<DirectoryMatch "/assets/">
    <FilesMatch "\.php$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# Protect Yii2 console script
<FilesMatch "^(yii|yii\.bat)$">
    Require all denied
</FilesMatch>

# Protect Yii2 requirements checker (if in web root)
<FilesMatch "^requirements\.php$">
    Require all denied
</FilesMatch>

#==============================================================================
# PHP Security
#==============================================================================

# Deny access to raw PHP sources and includes
<FilesMatch "\.phps$">
    Require all denied
</FilesMatch>

<FilesMatch "\.php\..*$">
    Require all denied
</FilesMatch>

<FilesMatch "\.inc$">
    Require all denied
</FilesMatch>

# Deny access to PHP configuration files
<FilesMatch "^(php\.ini|\.user\.ini)$">
    Require all denied
</FilesMatch>

#==============================================================================
# Enhanced Security Headers
#==============================================================================

<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header always setifempty X-Content-Type-Options "nosniff"

    # Prevent clickjacking attacks
    Header always setifempty X-Frame-Options "SAMEORIGIN"

    # Referrer policy for privacy
    Header always setifempty Referrer-Policy "strict-origin-when-cross-origin"

    # Remove X-Powered-By; ServerTokens Prod handles Server header
    Header always unset "X-Powered-By"
    Header unset "X-Powered-By"

    # Permissions policy (formerly Feature Policy)
    Header always setifempty Permissions-Policy "camera=(), microphone=(), geolocation=(), interest-cohort=()"

    # Prefer defining CSP once in main config, but set a basic one here
    Header always setifempty Content-Security-Policy "\
        default-src 'self'; \
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; \
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; \
        img-src 'self' data: https:; \
        font-src 'self' data: https://cdn.jsdelivr.net; \
        connect-src 'self'; \
        frame-ancestors 'self'"

    # Cross-Origin policies
    Header always setifempty Cross-Origin-Embedder-Policy "require-corp"
    Header always setifempty Cross-Origin-Opener-Policy "same-origin"
    Header always setifempty Cross-Origin-Resource-Policy "same-origin"
</IfModule>

#==============================================================================
# HTTPS Security Headers (when SSL is enabled)
#==============================================================================

<IfModule mod_ssl.c>
    <IfModule mod_headers.c>
        # HTTP Strict Transport Security (HSTS)
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    </IfModule>
</IfModule>

#==============================================================================
# Directory Listing and Options Security
#==============================================================================

# Disable directory browsing globally
Options -Indexes

# Disable server-side includes and CGI globally
Options -Includes -ExecCGI

# Disable following symbolic links (security measure)
# Note: Comment out if your application requires symlinks
# Options -FollowSymLinks

#==============================================================================
# File Upload Security
#==============================================================================

# Limit file upload size to prevent DoS (100MB)
LimitRequestBody 104857600

# Note: HTTP method restrictions are applied in virtual host configuration

#==============================================================================
# Error Pages Security
#==============================================================================

# Custom error pages to prevent information disclosure
# ErrorDocument 403 /error/403.html
# ErrorDocument 404 /error/404.html
# ErrorDocument 500 /error/500.html

# Prevent access to error log files
<FilesMatch "error_log">
    Require all denied
</FilesMatch>

#==============================================================================
# Additional Security Measures
#==============================================================================

# Disable HTTP TRACE method (already set in main config but reinforcing)
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} ^TRACE
    RewriteRule .* - [F]
</IfModule>

# Timeout settings to prevent slowloris attacks (set in main config)
# These are handled in the main apache2.conf file

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
