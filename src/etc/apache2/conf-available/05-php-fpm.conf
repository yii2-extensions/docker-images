#==============================================================================
# PHP-FPM Proxy Configuration
# FastCGI Process Manager integration with security
#==============================================================================

#------------------------------------------------------------------------------
# Directory Index
#------------------------------------------------------------------------------
DirectoryIndex index.php index.html index.htm

#------------------------------------------------------------------------------
# Environment Variables and Headers
#------------------------------------------------------------------------------
# Custom environment variables
ProxyFCGISetEnvIf "true" APPLICATION_ENV=production
ProxyFCGISetEnvIf "true" SERVER_ADMIN=webmaster@localhost

# Pass client certificate info (if using client certificates)
# ProxyFCGISetEnvIf "req('SSL_CLIENT_CERT') =~ /.+/" SSL_CLIENT_CERT=%{SSL:SSL_CLIENT_CERT}
# ProxyFCGISetEnvIf "req('SSL_CLIENT_S_DN') =~ /.+/" SSL_CLIENT_S_DN=%{SSL:SSL_CLIENT_S_DN}

# Pass essential headers to PHP
ProxyFCGISetEnvIf "req('Authorization') =~ /.+/" HTTP_AUTHORIZATION=%{HTTP:Authorization}
ProxyFCGISetEnvIf "req('X-Forwarded-For') =~ /.+/" HTTP_X_FORWARDED_FOR=%{HTTP:X-Forwarded-For}
ProxyFCGISetEnvIf "req('X-Forwarded-Host') =~ /.+/" HTTP_X_FORWARDED_HOST=%{HTTP:X-Forwarded-Host}
ProxyFCGISetEnvIf "req('X-Forwarded-Port') =~ /.+/" HTTP_X_FORWARDED_PORT=%{HTTP:X-Forwarded-Port}
ProxyFCGISetEnvIf "req('X-Forwarded-Proto') =~ /.+/" HTTP_X_FORWARDED_PROTO=%{HTTP:X-Forwarded-Proto}
ProxyFCGISetEnvIf "req('X-Real-IP') =~ /.+/" HTTP_X_REAL_IP=%{HTTP:X-Real-IP}

# Set remote user for authentication
ProxyFCGISetEnvIf "req('REMOTE_USER') =~ /.+/" REMOTE_USER=%{HTTP:REMOTE_USER}

#------------------------------------------------------------------------------
# Error Handling
#------------------------------------------------------------------------------
# Custom error pages for PHP errors
<IfModule mod_proxy.c>
    # Don't forward certain errors
    ProxyErrorOverride On

    # Custom error documents
    ErrorDocument 502 "Service temporarily unavailable"
    ErrorDocument 503 "Service temporarily unavailable"
    ErrorDocument 504 "Gateway timeout"
</IfModule>

#------------------------------------------------------------------------------
# Logging for PHP Requests
#------------------------------------------------------------------------------
<IfModule mod_log_config.c>
    # Special log format for PHP requests
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T php:%{FCGI_ROLE}e backend:%{proxy:target}n" php_combined

    # Log slow PHP requests (if slowlog is enabled in PHP-FPM)
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T [SLOW]" php_slow
</IfModule>

#------------------------------------------------------------------------------
# Performance Optimizations
#------------------------------------------------------------------------------
# Optimize proxy buffer sizes for PHP responses
<IfModule mod_proxy_fcgi.c>
    # Backend type
    ProxyFCGIBackendType GENERIC

    # Buffer settings for large responses
    ProxyFCGISetEnvIf "true" proxy-fcgi-pathinfo=full
</IfModule>

#------------------------------------------------------------------------------
# PHP File Handling
#------------------------------------------------------------------------------
# Handle PHP files with enhanced security and performance
<FilesMatch "\.php$">
    <If "-f %{REQUEST_FILENAME}">
        SetHandler "proxy:unix:/var/run/php/php-fpm.sock|fcgi://php-fpm"

        # Security headers for PHP responses
        <IfModule mod_headers.c>
            Header always set X-Content-Type-Options "nosniff"
            Header always set X-Frame-Options "SAMEORIGIN"
        </IfModule>

        # CGI environment variables
        CGIPassAuth On
    </If>
</FilesMatch>

#------------------------------------------------------------------------------
# PHP-FPM proxy via Unix socket (faster than TCP)
#------------------------------------------------------------------------------
<Proxy "unix:/var/run/php/php-fpm.sock|fcgi://php-fpm">
    # Connection settings
    ProxySet connectiontimeout=10
    ProxySet retry=300
    ProxySet timeout=300
    ProxySet ttl=60

    # Performance settings
    ProxySet flushpackets=on
    ProxySet flushwait=10

    # Pool management
    ProxySet max=20
    ProxySet min=0
    ProxySet smax=10
</Proxy>

#------------------------------------------------------------------------------
# PHP-FPM Status and Monitoring
#------------------------------------------------------------------------------
<IfDefine ENABLE_FPM_STATUS>
    # FPM Status page (basic)
    <Location /fpm-status>
        SetHandler "proxy:unix:/var/run/php/php-fpm.sock|fcgi://php-fpm"

        # Access control
        Require local
        Require ip 127.0.0.1
        Require ip ::1

        # Don't log status requests
        SetEnv no_log 1

        # Security headers
        <IfModule mod_headers.c>
            Header always set X-Robots-Tag "noindex, nofollow, noarchive"
            Header always set Cache-Control "no-cache, no-store, must-revalidate"
        </IfModule>
    </Location>

    # FPM Status page (full details)
    <Location /fpm-status-full>
        SetHandler "proxy:unix:/var/run/php/php-fpm.sock|fcgi://php-fpm"


        # Add query string for full status
        ProxyPreserveHost On
        ProxyPass "unix:/var/run/php/php-fpm.sock|fcgi://php-fpm/fpm-status?full"

        # Access control - more restrictive
        Require ip 127.0.0.1
        Require ip ::1

        # Don't log status requests
        SetEnv no_log 1

        <IfModule mod_headers.c>
            Header always set X-Robots-Tag "noindex, nofollow, noarchive"
            Header always set Cache-Control "no-cache, no-store, must-revalidate"
        </IfModule>
    </Location>

    # FPM Ping page
    <Location /fpm-ping>
        SetHandler "proxy:unix:/var/run/php/php-fpm.sock|fcgi://php-fpm"

        # Access control
        Require local
        Require ip 127.0.0.1
        Require ip ::1

        # Don't log ping requests
        SetEnv no_log 1

        <IfModule mod_headers.c>
            Header always set X-Robots-Tag "noindex, nofollow, noarchive"
            Header always set Cache-Control "no-cache, no-store, must-revalidate"
            Header always set Content-Type "text/plain"
        </IfModule>
    </Location>
</IfDefine>

#------------------------------------------------------------------------------
# Security Restrictions
#------------------------------------------------------------------------------
# Prevent PHP execution in upload/asset directories
<DirectoryMatch "/(uploads|files|media|images|attachments|assets|storage|tmp)/">
    <FilesMatch "\.(php|php3|php4|php5|php7|php8|phtml|pl|py|jsp|asp|sh|cgi)$">
        Require all denied
    </FilesMatch>

    # Remove X-Powered-By header for these directories
    <IfModule mod_headers.c>
        Header always unset X-Powered-By
        Header always set X-Content-Type-Options "nosniff"
    </IfModule>
</DirectoryMatch>

# Block access to PHP source files
<FilesMatch "\.(phps|php~|php\.bak|php\.old|php\.orig|php\.save)$">
    Require all denied
</FilesMatch>

# Block access to PHP configuration files
<FilesMatch "^\.user\.ini$">
    Require all denied
</FilesMatch>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
