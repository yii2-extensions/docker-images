#==============================================================================
# Compression Configuration - Brotli + Gzip
#==============================================================================

#------------------------------------------------------------------------------
# Brotli Compression
#------------------------------------------------------------------------------
<IfModule mod_brotli.c>
    # Basic Brotli parameters
    BrotliAlterETag AddSuffix
    BrotliCompressionMaxInputBlock 16
    BrotliCompressionQuality 6
    BrotliCompressionWindow 18

    # Apply Brotli to common web content types
    AddOutputFilterByType BROTLI_COMPRESS \
        application/atom+xml \
        application/javascript \
        application/json \
        application/ld+json \
        application/manifest+json \
        application/vnd.ms-fontobject \
        application/x-font-ttf \
        application/x-web-app-manifest+json \
        application/xhtml+xml \
        application/xml \
        application/xml+rss \
        font/opentype \
        image/svg+xml \
        image/x-icon \
        text/cache-manifest \
        text/css \
        text/html \
        text/javascript \
        text/plain \
        text/vtt \
        text/xml

    # Don't compress already compressed files
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png|webp|woff2?|ico|zip|gz|br|rar|bz2|7z|tar|pdf|mp[34]|avi|mov|wmv|flv)$ \
        no-brotli

    # Disable gzip if Brotli is active
    SetEnv no-gzip 1
</IfModule>

#------------------------------------------------------------------------------
# Gzip Compression (Fallback)
#------------------------------------------------------------------------------
<IfModule mod_deflate.c>
    # Only use gzip if Brotli module is not available
    <IfModule !mod_brotli.c>
        # Basic deflate parameters
        DeflateAlterETag AddSuffix
        DeflateBufferSize 8096
        DeflateCompressionLevel 6
        DeflateWindowSize 15

        # Apply to same content types as Brotli
        AddOutputFilterByType DEFLATE \
            application/atom+xml \
            application/javascript \
            application/json \
            application/ld+json \
            application/manifest+json \
            application/vnd.ms-fontobject \
            application/x-font-ttf \
            application/x-web-app-manifest+json \
            application/xhtml+xml \
            application/xml \
            application/xml+rss \
            font/opentype \
            image/svg+xml \
            image/x-icon \
            text/cache-manifest \
            text/css \
            text/html \
            text/javascript \
            text/plain \
            text/vtt \
            text/xml

        # Don't compress already compressed files
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png|webp|woff2?|ico|zip|gz|br|rar|bz2|7z|tar|pdf|mp[34]|avi|mov|wmv|flv)$ \
            no-gzip
    </IfModule>
</IfModule>

#------------------------------------------------------------------------------
# Shared Settings
#------------------------------------------------------------------------------
# Headers for compression and caching
<IfModule mod_headers.c>
    Header merge Vary "Accept-Encoding"
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
