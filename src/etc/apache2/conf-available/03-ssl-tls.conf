#==============================================================================
# SSL/TLS Configuration
# TLS 1.2+ with Perfect Forward Secrecy
#==============================================================================

<IfModule ssl_module>
    #--------------------------------------------------------------------------
    # Certificate and Key Management
    #--------------------------------------------------------------------------
    # Certificate verification
    SSLVerifyClient none
    SSLVerifyDepth 10

    #--------------------------------------------------------------------------
    # Logging and Debugging
    #--------------------------------------------------------------------------
    # SSL logging (reduce in production)
    LogLevel ssl:warn

    # SSL log format
    <IfModule log_config_module>
        LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{ms}T ssl:%{SSL_PROTOCOL}x cipher:%{SSL_CIPHER}x" ssl_combined
    </IfModule>

    #--------------------------------------------------------------------------
    # OCSP Stapling - Enhanced Security
    #--------------------------------------------------------------------------
    # Enable OCSP stapling for certificate validation
    SSLStaplingCache "shmcb:/var/cache/apache2/ssl_stapling(131072)"
    SSLStaplingErrorCacheTimeout 60
    SSLStaplingFakeTryLater off
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off
    SSLStaplingStandardCacheTimeout 3600
    SSLUseStapling on

    #--------------------------------------------------------------------------
    # Protocol and Cipher Configuration
    #--------------------------------------------------------------------------
    # Let client choose (modern clients make good choices)
    SSLHonorCipherOrder off

    # Modern cipher suites (prioritize ECDHE and ChaCha20)
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384

    # Modern TLS protocols only
    SSLProtocol -all +TLSv1.2 +TLSv1.3

    # TLS 1.3 cipher suites (handled automatically)
    SSLCipherSuite TLSv1.3 TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256

    #--------------------------------------------------------------------------
    # Security Headers for HTTPS
    #--------------------------------------------------------------------------
    <IfModule mod_headers.c>
        # Certificate Transparency monitoring
        Header always set Expect-CT "max-age=86400" "expr=%{HTTPS} == 'on'"

        # HTTP Strict Transport Security (2 years)
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" "expr=%{HTTPS} == 'on'"

        # Public Key Pinning (use with caution, requires careful management)
        # Header always set Public-Key-Pins "pin-sha256=\"base64+primary+key+hash\"; pin-sha256=\"base64+backup+key+hash\"; max-age=5184000; includeSubDomains" "expr=%{HTTPS} == 'on'"
    </IfModule>

    #--------------------------------------------------------------------------
    # SSL Engine Configuration
    #--------------------------------------------------------------------------
    # OpenSSL configuration
    SSLOpenSSLConfCmd Curves X25519:secp384r1:secp256r1
    SSLOpenSSLConfCmd ECDHParameters secp384r1

    # Random number generation
    SSLRandomSeed connect builtin
    SSLRandomSeed connect file:/dev/urandom 512
    SSLRandomSeed startup builtin
    SSLRandomSeed startup file:/dev/urandom 512

    # SSL Engine optimizations
    SSLCompression off
    SSLInsecureRenegotiation off

    #--------------------------------------------------------------------------
    # Session Management - Optimized for Performance
    #--------------------------------------------------------------------------
    # Session cache configuration
    SSLSessionCache "shmcb:/var/cache/apache2/ssl_scache(1048576)"
    SSLSessionCacheTimeout 600
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
