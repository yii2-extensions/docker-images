---
on:
  pull_request:
    paths-ignore:
      - ".gitattributes"
      - ".gitignore"
      - "CHANGELOG.md"
      - "docs/**"
      - "README.md"

  push:
    branches:
      - main
    paths-ignore:
      - ".gitattributes"
      - ".gitignore"
      - "CHANGELOG.md"
      - "docs/**"
      - "README.md"

concurrency:
  group: build-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

name: build

env:
  REGISTRY: ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        build_type: [dev, full, prod]

    steps:
      - name: Checkout.
        uses: actions/checkout@v5

      - name: Setup Docker Buildx.
        uses: docker/setup-buildx-action@v3

      - name: Prepare Tags.
        id: tags
        uses: ./.github/actions/prepare-docker-tags@main
        with:
          base-name: >-
            ${{ inputs.registry }}/${{ inputs.repository-owner }}/${{ inputs.tag-prefix }}
          build-type: ${{ matrix.build_type }}
          php-version: ${{ inputs.php-version }}

      - name: Build Only.
        uses: docker/build-push-action@v6
        env:
          SCOPE: ${{ github.head_ref || github.ref_name }}
        with:
          context: .
          file: ./src/flavor/apache/Dockerfile
          push: false
          tags: ${{ steps.tags.outputs.TAG }}
          build-args: |
            BUILD_TYPE=${{ matrix.build_type }}
            PHP_VERSION=${{ steps.tags.outputs.PHP_VERSION }}
          cache-from: >-
            type=gha,scope=${{ env.SCOPE }}-${{ matrix.build_type }}
          cache-to: >-
            type=gha,mode=max,scope=${{ env.SCOPE }}-${{ matrix.build_type }}
          provenance: false
          sbom: false

      - name: Show result.
        env:
          BUILD_TYPE: ${{ matrix.build_type }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          echo "ðŸŽ‰ Build completed for ${BUILD_TYPE}!"
          echo "Event: ${EVENT_NAME}"
          echo "Tags: ${{ steps.tags.outputs.TAG }}"
          if [[ "${EVENT_NAME}" == "push" ]]; then
            echo "âœ… Image pushed to registry"
          else
            echo "â„¹ï¸ Image built but not pushed (PR mode)"
          fi

      - name: Clear old GitHub Actions caches.
        if: >-
          ${{ github.event_name == 'push' && matrix.build_type == 'full' }}
        uses: easimon/wipe-cache@main
